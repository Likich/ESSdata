---
title: "Домашняя работа №3"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

*Парфенова Ангелина, 162*

*16 Октября 2019*

<hr/><hr/>

## Анализ предикторов доверия в России


<span style="color:#BE3F52">**Содержательная гипотеза**</span>. Предположительно, доверие людям в России зависит от веры в то, что люди являются скорее честными, в то, что люди помогают, а также предположительно возраста и их места жительства. Так, взрослые могут скорее больше доверять людям, чем молодые, а жители деревни больше доверять людям в целом, чем жители больших городов. Также, предположительно, присутствует эффект взаимодействия между местом жительства респондента и верой в то, что люди склонны помогать: жители деревни более склонны думать о людях, как помогающих, что может привести к большему доверию.

<span style="color:#BE3F52">**Статистическая гипотеза**</span>: R квадрат равен нулю, все коэффициенты при предикторах равны нулю в генеральной совокупности, константа равна нулю в генеральной совокупности.

Для начала загрузим все необходимые пакеты и базу данных для анализа

```{r message=FALSE, warning=FALSE}
library(foreign)
library(lmtest)
library(car)
library(effects)
library(ggplot2)
library(colourpicker)
library(reshape2)
library(kableExtra)
library(knitr)
library(broom)
mydata <- read.spss(
  file = "ESS4e04_5.sav",
  use.value.labels = F,
  use.missings = T,
  to.data.frame = T)
```

<span style="color:#30B676">*Анализироваться будут следующие переменные: ppltrst(A8), pplfair(A9), pplhlp(A10), trstlgl(B4), trstplc(B5), trstplt(B6), trstep(B7), trstun(B8), trstprt(B9), trstprl(B10)*</span>.


Я выбрала как <span style="color:#BE3F52">*зависимую*</span> - переменную доверия людям так, как она измерена по 11-бальной шкале, а значит ее можно считать интервальной. Посмотрим как закодирована <span style="color:#2384BA">Россия</span> в наборе данных. 

```{r}
levels(mydata$cntry)
mydata.RU <- subset(mydata, cntry == "RU")

```


Посмотрим основные статистики относительно зависимой переменной: **среднее** и **стандартное отклонение**.


```{r}
mean(mydata.RU$ppltrst, na.rm = T)
sd(mydata.RU$ppltrst, na.rm = T)
```

```{r echo=TRUE, message=FALSE, warning=FALSE}
ggplot(mydata.RU, aes(x=ppltrst))+
  geom_bar(fill = "#BFEFFF", colour = "darkblue")+
  geom_label(stat = "count", aes(y = stat(count), label = stat(count)))+
  xlab("Доверие людям") +
  ylab("Частота")
 
```

Гистограмма была выбрана по следующим причинам: **во первых** - это было требование первого домашнего задания :) , **во вторых** - это наглядное представление функции плотности вероятности доверия людям, построенное по Российской выборке.

Посмотрим среднее значение доверия людям у мужчин и женщин.

```{r}
mean(mydata.RU$ppltrst [mydata.RU$gndr == 1], na.rm = T)
mean(mydata.RU$ppltrst [mydata.RU$gndr == 2], na.rm = T)
```

Таким образом, среднее доверие людям среди россиян равно `r mean(mydata.RU$ppltrst [mydata.RU$gndr == 1], na.rm = T)` 

Срееднее доверие среди россиянок равно `r mean(mydata.RU$ppltrst [mydata.RU$gndr == 2], na.rm = T)` 


```{r}
dispers<-aov(mydata.RU$ppltrst ~ as.factor(mydata.RU$gndr))
coeff.table <- summary(dispers) 
```

*Разница средних в группах по полу являются значимой*

```{r}
coef.table <- broom::tidy(dispers)
Table1 <-knitr::kable(coef.table, format="html", digits=2)
kableExtra::kable_styling(Table1, bootstrap_options=c("hover", "striped", "condensed")) 


t.test(
  mydata.RU$ppltrst [mydata.RU$gndr == 1],
  mydata.RU$ppltrst [mydata.RU$gndr == 2],
  paired = FALSE,
)
```


В базе переменные пола и места жительства представлены как "numeric", необходимо их превратить в тип "factor" - то есть категориальные.

```{r}
mydata.RU$gndr_f <- Recode(
  var =  mydata.RU$gndr,  
  recodes = "1=1; 2=2; else=NA",    
  as.factor=T)
mydata.RU$domicil_f <- Recode(
  var =  mydata.RU$domicil,  
  recodes = "1=1; 2=2; 3=3; 4=4; 5=5; else=NA",    
  as.factor=T)
```

**Распределение зависимой переменной**

```{r}
ggplot(mydata.RU, aes(ppltrst, fill = "#B0E2FF"))+
  geom_density(alpha=0.6) +
xlab("Доверие людям") +
  ylab("Плотность распределения")+
  ggtitle("Плостность распределения зависимой переменной")
```

Данный тип графика был выбран по причине того, что зависимая переменная является интервальной. Также имеет смысл проверить является ли распределение приближенным к нормальному.

## Совместные распределения (2 варианта визуализации)

Давайте посмотрим совместные распределения некоторых переменных, которые мы хотим включить в модель: доверие людям(зависимая), вера в честность людей, вера в то, что люди помогают. Для этого на одном графике изобразим функции плотности распределения этих переменных (все они относятся к интервальному типу).

Следующий тип графика сможет наглядно изобразить распределения сразу трех переменных в координатном пространстве, что значительно облегчает работу по контролированию на критерий нормальности распределения каждой переменной по одной.

```{r warning=FALSE}
x <- list(ppltrst=mydata.RU$ppltrst,pplfair=mydata.RU$pplfair,pplhlp=mydata.RU$pplhlp)
data<- melt(x)
ggplot(data,aes(x=value, fill=L1)) + geom_density(alpha=0.25)
```

Следующий тип графика поможет узнать существует ли наглядная разница между уровнем доверия в разных местах проживания, до потдверждения статистической значимости этих различий. 

```{r warning=FALSE}

dat.clean1<- na.omit(subset(mydata.RU, select = c(ppltrst, domicil)))

ggplot(dat.clean1, aes(as.factor(domicil), fill = "red", ppltrst))+
  geom_boxplot(color = "pink", aes (fill = as.factor(domicil)))+
  scale_fill_viridis_d(option = "magma")+
ggtitle("Совместное распределение: доверие людям и место жительства")+
  xlab("Место жительства")+
ylab("Доверие людям")
```

<hr/>

Построим первую регрессионную модель с независимыми переменными: вера в честность людей, вера в помощь людей, возраст, место жительства и пол.

# Модель №1
```{r}
reg1 <- lm(ppltrst ~  pplfair + pplhlp + agea + domicil_f + gndr_f,
           data = mydata.RU)
reg1table <- summary(reg1)
coef.table <- broom::tidy(reg1table)
Table2 <-knitr::kable(coef.table, format="html", digits=2)
kableExtra::kable_styling(Table2, bootstrap_options=c("hover", "striped", "condensed")) 


mydata.RU$domicil3 <- Recode(
  var =  mydata.RU$domicil,  
  recodes = "5=0; 4=0; 3=1; 2=0; 1=0; else=NA",    
  as.factor=T)
```

Пол и все места жительства незначимы в модели, кроме «города или маленького города». Поэтому мы оставили только это место жительства.

Прежде чем перейти в построению регрессионной модели, посмотрим на графике как могут взаимодействовать зависимая переменная и три независимых - возраст, вера в то что люди помогают и место жительства. Для этого мы сначала перекодируем возраст в 5 категорий.

Данный тип графика сможет наглядно изобразить взаимодействие зависимой и сразу трех независимых переменных в одном координатном пространстве, что поможет в построении будущих регрессионных моделей. Мы также сможем наглядно увидеть имеет ли смысл оставлять некоторые предполагаемые нами предикторы в модели, а какие могут потенциально оказывать значимое влияние на зависимую переменную.

```{r warning=FALSE}
mydata.RU$agea_r <- Recode(
  var =  mydata.RU$agea,  
  recodes = "15:25=1; 26:35=2; 36:55=3; 56:65=4; 66:75 =5; else=NA",    
  as.factor=T)

dat.clean<- na.omit(subset(mydata.RU, select = c(ppltrst, pplfair, domicil_f, agea_r)))

ggplot(dat.clean, aes(y=ppltrst, x=pplfair, color = domicil_f, shape = agea_r, drop_na()))+
  geom_point()+
  geom_smooth(method = "lm", aes(shape = ""), color = "black")+
  facet_wrap(~domicil_f)+
  xlab("Вера в честность")+
  ylab("Доверие людям")+
  ggtitle("Одна зависимая и три независимых переменных")
  
```

# Модель №2

```{r}
reg2 <- lm(ppltrst ~  pplfair + pplhlp + agea + domicil3,
           data = mydata.RU)
reg2table <- summary(reg2)
coef.table <- broom::tidy(reg2table)
Table3 <-knitr::kable(coef.table, format="html", digits=2)
kableExtra::kable_styling(Table3, bootstrap_options=c("hover", "striped", "condensed")) 
```

Место жительства не значимо в определении доверия.
Построим итоговую регрессионную модель без учета всех незначимых коэффициентов.

# Модель №3

```{r}
reg3 <- lm(ppltrst ~  pplfair + pplhlp + agea,
           data = mydata.RU)
reg3table <- summary(reg3)
coef.table <- broom::tidy(reg3table)
Table4 <-knitr::kable(coef.table, format="html", digits=2)
kableExtra::kable_styling(Table4, bootstrap_options=c("hover", "striped", "condensed")) 

car::vif(reg3)
lmtest::bptest(reg3)
```

Теперь,проверим значимость эффекта взаимодействия в регрессионной модели.

# Модель №4

```{r}
reg4 <- lm(ppltrst ~  pplfair + pplhlp*domicil_f + agea,
           data = mydata.RU)
reg4table <- summary(reg4)
coef.table <- broom::tidy(reg4table)
Table5 <-knitr::kable(coef.table, format="html", digits=2)
kableExtra::kable_styling(Table5, bootstrap_options=c("hover", "striped", "condensed")) 
car::vif(reg4)
lmtest::bptest(reg4)
```

*Проинтерпретируем финальную модель*

**Мультиколлинеарность**: Для всех независимых переменных VIF приближен к единице, что позволяет утверждать, что отсутствует проблема мультиколлинеарности. 

**Гетероскедастичность**: На уровне доверительной вероятности 95% можно отвергнуть нулевую гипотезу о гомоскедастичности, таким образом, присутствует гетероскедастичность.



**Изображение эффекта взаимодействия**

```{r}
eff <- effect("pplhlp*domicil_f", reg4, se=T)
plot(eff, multiline = T, confint = list(style="bands"), rug=F,
     xlab = "People help", ylab = "Trust in people")


```

## Интерпретация финальной модели:
	
	R-квадрат является значимым при любом уровне доверительной вероятности и равен 0.304. Это означает, что 30% дисперсии доверия людям объясняется выбранным набором предикторов в генеральной совокупности.

   1)   При уровне доверительной вероятности 95%, имеются основания отвергнуть нулевую гипотезу о равенстве константы нулю (sig = 0,000). Так, вне зависимости от веры в честность, в желание людей помочь, в также вне зависимости от возраста, уровень доверия людям жителей большого города в среднем составляет `r coef(reg4)[1] ` балла.

   2)   При уровне доверительной вероятности 95%, имеются основания отвергнуть нулевую гипотезу о равенстве нулю коэффициента при вере в честность людей нулю в генеральной совокупности (sig = 0,000). Так, при увеличении веры в честность людей на единицу, доверие к людям увеличивается на `r coef(reg4)[2] ` балла вне зависимости от уверенности в том, что люди помогают, возраста и места жительства.

   3)   При уровне доверительной вероятности 95%, имеются основания отвергнуть нулевую гипотезу о равенстве нулю коэффициента при вере в то, что люди помогают в генеральной совокупности (sig = 0,000). Так, при увеличении уверенности в том, что люди помогают на единицу, доверие к людям увеличивается на `r coef(reg4)[3] ` балла вне зависимости от веры в честность людей, возраста и места жительства.

   4)   При уровне доверительной вероятности 95%, имеются основания отвергнуть нулевую гипотезу о равенстве нулю коэффициента при жительстве в маленьком городе нулю (sig = 0,002). Следовательно, уровень доверия людям в маленьких городах на `r coef(reg4)[5] ` балла больше, чем у жителей больших городов вне зависимости от возраста, веры в желание помочь и в честность.

   5)   При уровне доверительной вероятности 95%, имеются основания отвергнуть нулевую гипотезу о равенстве нулю коэффициента при жительстве на ферме или доме в деревне (sig = 0,002). Следовательно, уровень доверия людям, живущих на ферме на `r coef(reg4)[7] ` балла больше, чем у жителей больших городов вне зависимости от возраста, веры в желание помочь и в честность.

   6)   При уровне доверительной вероятности 95%, имеются основания отвергнуть нулевую гипотезу о равенстве нулю коэффициента при возрасте в генеральной совокупности (sig = 0,000). Так, при увеличении возраста на один год, доверие к людям уменьшается на `r coef(reg4)[8] ` балла вне зависимости от веры в честность людей, в то, что они могут помочь, и места жительства. Таким образом, содержательная гипотеза была опровергнута.

   7)   При уровне доверительной вероятности 95% эффект взаимодействия места жительства и веры в то, что люди в целом склонны помогать является значимым в генеральной совокупности для жителей маленьких городов, деревень и ферм. Мы можем отвергнуть нулевую гипотезу о равенстве этих коэффициентов нулю.

   8)   Так, среди жителей маленьких городов увеличение веры в то, что люди помогают на 1 снижает уровень доверия людям на `r coef(reg4)[10] ` балла больше, чем среди жителей большого города, которые считают, что люди заботятся только о себе. Среди жителей деревень увеличение веры в то, что люди помогают на 1 снижает уровень доверия людям на `r coef(reg4)[11] ` балла больше, чем среди жителей большого города, которые считают, что люди заботятся только о себе. Среди жителей ферм увеличение веры в то, что люди помогают на 1 снижает уровень доверия людям на `r coef(reg4)[12] ` балла больше, чем среди жителей большого города, которые считают, что люди заботятся только о себе. Таким образом, содержательные гипотезы касаемо эффекта взаимодействия между местом жительства и желанием помочь людям не подтвердились. Жители деревень и ферм, наоборот, склонны при вере в то, что люди помогают, меньше им доверять.







